<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Wrapped — Vanilla JS</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --panel: #121212;
      --panel2: #1a1a1a;
      --border: #2e2e2e;
      --text: #fafafa;
      --muted: #b3b3b3;
      --chip: #2a2a2a;
      --white: #fff;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    .container { max-width: 1120px; margin: 0 auto; padding: 40px 24px; }
    .header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 24px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo { width: 40px; height: 40px; border-radius: 12px; background: var(--white); }
    .title { font-weight: 800; font-size: 28px; }
    .subtitle { color: var(--muted); font-size: 13px; }
    .btn { cursor: pointer; padding: 10px 16px; border-radius: 12px; border: 1px solid var(--border); background: var(--panel2); color: var(--text); font-weight: 600; }
    .btn.primary { background: var(--white); color: #111; border-color: var(--white); }
    .btn:hover { filter: brightness(1.05); }
    .profile { display: flex; align-items: center; gap: 10px; }
    .avatar { width: 44px; height: 44px; border-radius: 999px; overflow: hidden; background: #333; display:flex; align-items:center; justify-content:center; font-weight:700; }

    .notice { padding: 14px; border: 1px solid var(--border); background: #121212; border-radius: 12px; color: #ddd; margin-bottom: 18px; }

    .tabs { display: flex; gap: 8px; margin: 20px 0; }
    .tab { padding: 8px 14px; border-radius: 10px; border:1px solid var(--border); background: var(--panel2); color: var(--text); font-size: 14px; }
    .tab.active { background: var(--white); color: #111; border-color: var(--white); }

    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 768px) { .grid { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 1024px) { .grid { grid-template-columns: 1fr 1fr 1fr; } }

    .card { background: linear-gradient(135deg, #0f0f0f, #161616); border: 1px solid var(--border); border-radius: 16px; padding: 18px; }
    .card h3 { margin: 0 0 12px; font-size: 18px; }
    .list { list-style: none; padding: 0; margin: 0; }
    .row { display: flex; align-items: center; gap: 10px; padding: 6px 0; }
    .rank { width: 22px; color: #a0a0a0; text-align: right; }
    .thumb { width: 40px; height: 40px; border-radius: 8px; background: #2a2a2a; object-fit: cover; }
    .meta { flex: 1; min-width: 0; }
    .meta .name { font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .meta .sub { font-size: 12px; color: #9c9c9c; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { background: #1f1f1f; border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 999px; font-size: 12px; }

    .bar { margin-bottom: 8px; }
    .bar-top { display:flex; justify-content: space-between; font-size: 11px; color: #bdbdbd; }
    .bar-rail { height: 8px; background: #2a2a2a; border-radius: 6px; overflow: hidden; }
    .bar-fill { height: 100%; background: #fff; width: 0; }

    .recent { max-height: 320px; overflow: auto; padding-right: 4px; }
    .muted { color: #bfbfbf; }

    .footer { margin-top: 28px; text-align: center; color: #9b9b9b; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Your Wrapped</div>
          <div class="subtitle">Personal Spotify stats — privately, in your browser.</div>
        </div>
      </div>
      <div id="authArea"></div>
    </div>

    <div id="setup" class="notice" style="display:none">
      <strong>Setup required:</strong>
      Edit <code>CLIENT_ID</code> and (optionally) <code>REDIRECT_URI</code> inside this file, then click “Log in with Spotify”.
    </div>

    <div class="tabs">
      <button class="tab active" data-range="short_term">Last 4 weeks</button>
      <button class="tab" data-range="medium_term">Last 6 months</button>
      <button class="tab" data-range="long_term">All time</button>
    </div>

    <div id="status" class="muted" style="margin-bottom:12px"></div>

    <div id="grid" class="grid" style="display:none">
      <div class="card">
        <h3>Top Artists</h3>
        <ol id="artists" class="list"></ol>
      </div>
      <div class="card">
        <h3>Top Tracks</h3>
        <ol id="tracks" class="list"></ol>
      </div>
      <div class="card">
        <h3>Your Top Genres</h3>
        <div id="genres" class="chips"></div>
      </div>
      <div class="card">
        <h3>Vibes (Top Tracks Averages)</h3>
        <div id="vibes"></div>
      </div>
      <div class="card">
        <h3>Recently Played (last ~50)</h3>
        <div id="recent" class="recent"></div>
      </div>
      <div class="card">
        <h3>Shareable Summary (Copy/Paste)</h3>
        <div id="summary" style="white-space:pre-wrap; font-size:12px"></div>
      </div>
    </div>

    <div class="footer">Built with ❤️ using the Spotify Web API. This app is not affiliated with Spotify.</div>
  </div>

  <script>
  const CLIENT_ID = '6f1bcbe56bef45d28dec0ac09ca8c817';
  const REDIRECT_URI = 'https://www.longno.co.uk/spotify'; // must exactly match your Spotify app Redirect URI
  const SCOPES = ['user-top-read', 'user-read-recently-played'].join(' ');

  function randomString(length = 64) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
    let str = '';
    const array = new Uint8Array(length);
    crypto.getRandomValues(array);
    for (let i = 0; i < length; i++) str += chars[array[i] % chars.length];
    return str;
  }
  async function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return new Uint8Array(hash);
  }
  function b64url(bytes) {
    let str = btoa(String.fromCharCode(...bytes));
    return str.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }
  async function createCodeChallenge(verifier) { return b64url(await sha256(verifier)); }
  function saveAuth(obj){ localStorage.setItem('spotify_auth', JSON.stringify(obj)); }
  function loadAuth(){ try { return JSON.parse(localStorage.getItem('spotify_auth')) || null; } catch { return null; } }
  function clearAuth(){ localStorage.removeItem('spotify_auth'); }

  async function tokenExchange({ code, verifier }){
    const body = new URLSearchParams({
      client_id: CLIENT_ID,
      grant_type: 'authorization_code',
      code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier,
    });
    const res = await fetch('https://accounts.spotify.com/api/token', { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body });
    if(!res.ok) throw new Error('Token exchange failed');
    return res.json();
  }
  async function refreshToken(refresh_token){
    const body = new URLSearchParams({ client_id: CLIENT_ID, grant_type:'refresh_token', refresh_token });
    const res = await fetch('https://accounts.spotify.com/api/token', { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body });
    if(!res.ok) throw new Error('Refresh failed');
    return res.json();
  }
  async function apiGet(token, path, params={}){
    const url = new URL(`https://api.spotify.com/v1/${path}`);
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if(res.status === 401) throw new Error('unauthorized');
    if(!res.ok) throw new Error(`API error: ${res.status}`);
    return res.json();
  }
  const getMe = (t) => apiGet(t, 'me');
  const getTop = (t, type='tracks', time_range='medium_term', limit=20) => apiGet(t, `me/top/${type}`, { time_range, limit });
  const getAudioFeatures = (t, ids=[]) => ids.length ? apiGet(t, 'audio-features', { ids: ids.slice(0,100).join(',') }) : Promise.resolve({ audio_features: [] });
  const getRecentlyPlayed = (t, limit=50) => apiGet(t, 'me/player/recently-played', { limit: String(limit) });

  // ========================== STATE =========================
  let ACCESS_TOKEN = loadAuth()?.access_token || null;
  let REFRESH_TOKEN = loadAuth()?.refresh_token || null;
  let EXPIRES_IN = loadAuth()?.expires_in || 0;
  let OBTAINED_AT = loadAuth()?.obtained_at || 0;
  let PROFILE = null;
  let DATA = { artists: {}, tracks: {} };
  let FEATURES = {}; // per range averages
  let RECENT = null;
  let TIME_RANGE = 'short_term';

  const $ = (sel) => document.querySelector(sel);
  function setStatus(msg){ $('#status').textContent = msg || ''; }
  function setAuthArea(){
    const el = $('#authArea');
    if(ACCESS_TOKEN){
      const initial = (PROFILE?.display_name||'U').slice(0,1).toUpperCase();
      const img = PROFILE?.images?.[0]?.url ? `<img src="${PROFILE.images[0].url}" class="avatar"/>` : `<div class="avatar">${initial}</div>`;
      el.innerHTML = `
        <div class="profile">
          ${img}
          <div>
            <div style="font-weight:700;font-size:14px">${PROFILE?.display_name||'User'}</div>
            <div class="muted" style="font-size:12px">${(PROFILE?.product||'').toUpperCase()}</div>
          </div>
          <button class="btn" id="logoutBtn" style="margin-left:8px">Logout</button>
        </div>`;
      const btn = document.getElementById('logoutBtn');
      if(btn){ btn.onclick = () => { clearAuth(); location.reload(); }; }
    } else {
      const btnHtml = '<button id="loginBtn" class="btn primary">Log in with Spotify</button>';
      el.innerHTML = btnHtml;
      const btn = document.getElementById('loginBtn');
      if(btn){ btn.onclick = beginLogin; }
    }
  }
  function showSetup(show){ const el = document.getElementById('setup'); if(el){ el.style.display = show ? 'block' : 'none'; } }
  function showGrid(show){ const el = document.getElementById('grid'); if(el){ el.style.display = show ? 'grid' : 'none'; } }

  function renderList(container, items, isTrack=false){
    container.innerHTML = items.slice(0,10).map((item, i) => {
      const img = isTrack ? (item.album?.images?.[2]?.url || item.album?.images?.[0]?.url) : (item.images?.[2]?.url || item.images?.[0]?.url);
      const sub = isTrack ? (item.artists?.map(a=>a.name).join(', ')) : (item.genres?.slice(0,2).join(' • '));
      return `<li class="row">
        <span class="rank">${i+1}.</span>
        <img class="thumb" src="${img||''}" alt=""/>
        <div class="meta">
          <div class="name">${item.name}</div>
          <div class="sub">${sub||''}</div>
        </div>
      </li>`;
    }).join('');
  }
  function averageFeatures(list){
    const keys = ['danceability','energy','valence','acousticness','instrumentalness','liveness','speechiness','tempo'];
    if(!list?.length) return {};
    const out = {}; keys.forEach(k=>out[k]=0);
    list.forEach(f=>keys.forEach(k=> out[k]+= (f?.[k]||0)));
    keys.forEach(k=> out[k] = out[k]/list.length);
    return out;
  }
  function renderVibes(container, avg){
    container.innerHTML = '';
    const maxes = { tempo: 220 };
    const entries = Object.entries(avg);
    if(entries.length === 0){ container.innerHTML = '<span class="muted">No audio features available.</span>'; return; }
    entries.forEach(([k,v])=>{
      const max = k==='tempo' ? maxes.tempo : 1;
      const pct = Math.max(0, Math.min(100, (v/max)*100));
      const wrap = document.createElement('div');
      wrap.className = 'bar';
      wrap.innerHTML = `
        <div class="bar-top"><span>${k==='valence' ? 'Valence (Positivity)' : (k.charAt(0).toUpperCase()+k.slice(1))}</span><span>${typeof v==='number'?v.toFixed(2):v}</span></div>
        <div class="bar-rail"><div class="bar-fill" style="width:${pct}%"></div></div>`;
      container.appendChild(wrap);
    });
  }
  function renderRecent(container, items){
    if(!items){ container.innerHTML = '<span class="muted">Not available.</span>'; return; }
    container.innerHTML = items.map(it=>{
      const t = it.track;
      const img = t?.album?.images?.[2]?.url || t?.album?.images?.[0]?.url || '';
      return `<div class="row">
        <img class="thumb" src="${img}" alt=""/>
        <div class="meta">
          <div class="name">${t?.name||''}</div>
          <div class="sub">${t?.artists?.map(a=>a.name).join(', ')||''}</div>
        </div>
        <div class="muted" style="font-size:11px">${new Date(it.played_at).toLocaleString()}</div>
      </div>`;
    }).join('');
  }
  function renderSummary(container, profile, rangeKey, tracks, artists, genres){
    const topGenres = genres.slice(0,5).map(([g])=>g).join(', ');
    const topTracks = tracks.slice(0,5).map((t,i)=>`${i+1}. ${t.name} — ${t.artists?.map(a=>a.name).join(', ')}`).join('\n');
    const topArtists = artists.slice(0,5).map((a,i)=>`${i+1}. ${a.name}`).join('\n');
    container.textContent = `User: ${profile?.display_name||'Unknown'}\n\nTime Range:\n${rangeKey.replace('_',' ')}\n\nTop 5 Tracks:\n${topTracks}\n\nTop 5 Artists:\n${topArtists}\n\nTop Genres:\n${topGenres}`;
  }

  async function maybeHandleRedirect(){
    const params = new URLSearchParams(location.search);
    const code = params.get('code');
    const stored = loadAuth();
    if(!ACCESS_TOKEN && code && stored?.code_verifier){
      try {
        const data = await tokenExchange({ code, verifier: stored.code_verifier });
        const auth = { ...stored, access_token: data.access_token, refresh_token: data.refresh_token || stored.refresh_token, expires_in: data.expires_in, obtained_at: Date.now() };
        saveAuth(auth);
        ACCESS_TOKEN = auth.access_token; REFRESH_TOKEN = auth.refresh_token; EXPIRES_IN = auth.expires_in; OBTAINED_AT = auth.obtained_at;
        history.replaceState({}, document.title, location.origin + location.pathname);
      } catch(err){ setStatus('Failed to sign in. Please try again.'); }
    }
  }

  async function ensureFreshToken(){
    if(!ACCESS_TOKEN || !REFRESH_TOKEN) return;
    const age = (Date.now() - (OBTAINED_AT||0))/1000;
    if(age > (EXPIRES_IN||3600) - 60){
      try{
        const r = await refreshToken(REFRESH_TOKEN);
        ACCESS_TOKEN = r.access_token; EXPIRES_IN = r.expires_in; OBTAINED_AT = Date.now();
        const stored = loadAuth()||{}; saveAuth({ ...stored, access_token: ACCESS_TOKEN, expires_in: EXPIRES_IN, obtained_at: OBTAINED_AT });
      }catch(e){ console.warn('Refresh failed', e); }
    }
  }

  async function loadAll(){
    if(!ACCESS_TOKEN) return;
    setStatus('Loading your stats…');
    try{
      PROFILE = await getMe(ACCESS_TOKEN);
      const [aS, aM, aL] = await Promise.all([
        getTop(ACCESS_TOKEN,'artists','short_term',20),
        getTop(ACCESS_TOKEN,'artists','medium_term',20),
        getTop(ACCESS_TOKEN,'artists','long_term',20),
      ]);
      const [tS, tM, tL] = await Promise.all([
        getTop(ACCESS_TOKEN,'tracks','short_term',20),
        getTop(ACCESS_TOKEN,'tracks','medium_term',20),
        getTop(ACCESS_TOKEN,'tracks','long_term',20),
      ]);
      DATA = { artists: { short_term: aS.items, medium_term: aM.items, long_term: aL.items }, tracks: { short_term: tS.items, medium_term: tM.items, long_term: tL.items } };

      const ids = (DATA.tracks[TIME_RANGE]||[]).map(t=>t.id);
      const feat = await getAudioFeatures(ACCESS_TOKEN, ids);
      FEATURES[TIME_RANGE] = averageFeatures(feat.audio_features||[]);

      try { RECENT = await getRecentlyPlayed(ACCESS_TOKEN, 50); } catch { /* optional */ }

      showGrid(true);
      const artistsEl = document.getElementById('artists');
      const tracksEl = document.getElementById('tracks');
      const genresEl = document.getElementById('genres');
      const vibesEl = document.getElementById('vibes');
      const recentEl = document.getElementById('recent');
      const summaryEl = document.getElementById('summary');
      const artists = DATA.artists[TIME_RANGE] || [];
      const tracks = DATA.tracks[TIME_RANGE] || [];
      renderList(artistsEl, artists, false);
      renderList(tracksEl, tracks, true);
      const counts = new Map();
      artists.forEach(a => (a.genres||[]).forEach(g => counts.set(g,(counts.get(g)||0)+1)));
      const sortedGenres = [...counts.entries()].sort((a,b)=>b[1]-a[1]);
      genresEl.innerHTML = sortedGenres.slice(0,15).map(([g])=>`<span class="chip">${g}</span>`).join('');
      renderVibes(vibesEl, FEATURES[TIME_RANGE] || {});
      renderRecent(recentEl, RECENT?.items);
      renderSummary(summaryEl, PROFILE, TIME_RANGE, tracks, artists, sortedGenres);

      setStatus('');
    }catch(e){
      console.error(e);
      setStatus(e.message?.includes('unauthorized') ? 'Session expired. Please log in again.' : "Couldn't load your stats.");
    }
  }

  function onRangeClick(e){
    const t = e.target;
    if(!t.classList || !t.classList.contains('tab')) return;
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    t.classList.add('active');
    TIME_RANGE = t.getAttribute('data-range');
    if(!ACCESS_TOKEN) return;
    const ids = (DATA.tracks[TIME_RANGE]||[]).map(tr=>tr.id);
    getAudioFeatures(ACCESS_TOKEN, ids).then(feat => {
      FEATURES[TIME_RANGE] = averageFeatures(feat.audio_features||[]);
      const artists = DATA.artists[TIME_RANGE] || [];
      const tracks = DATA.tracks[TIME_RANGE] || [];
      renderList(document.getElementById('artists'), artists, false);
      renderList(document.getElementById('tracks'), tracks, true);
      const counts = new Map();
      artists.forEach(a => (a.genres||[]).forEach(g => counts.set(g,(counts.get(g)||0)+1)));
      const sortedGenres = [...counts.entries()].sort((a,b)=>b[1]-a[1]);
      document.getElementById('genres').innerHTML = sortedGenres.slice(0,15).map(([g])=>`<span class="chip">${g}</span>`).join('');
      renderVibes(document.getElementById('vibes'), FEATURES[TIME_RANGE] || {});
      renderSummary(document.getElementById('summary'), PROFILE, TIME_RANGE, tracks, artists, sortedGenres);
    });
  }

  async function beginLogin(){
    if(!CLIENT_ID){ showSetup(true); alert('Set CLIENT_ID in the file first.'); return; }
    const code_verifier = randomString(64);
    const code_challenge = await createCodeChallenge(code_verifier);
    saveAuth({ code_verifier });
    const authUrl = new URL('https://accounts.spotify.com/authorize');
    authUrl.searchParams.set('client_id', CLIENT_ID);
    authUrl.searchParams.set('response_type', 'code');
    authUrl.searchParams.set('redirect_uri', REDIRECT_URI);
    authUrl.searchParams.set('scope', SCOPES);
    authUrl.searchParams.set('code_challenge_method', 'S256');
    authUrl.searchParams.set('code_challenge', code_challenge);
    const w = window.open(authUrl.toString(), '_blank');
    if(!w){
      alert('Pop-up blocked. Please allow pop-ups for this site, or open the link manually: ' + authUrl.toString());
    }
  }

  document.addEventListener('click', onRangeClick);

  window.addEventListener('storage', async (e) => {
    if(e.key === 'spotify_auth'){
      const auth = loadAuth();
      if(auth?.access_token){
        ACCESS_TOKEN = auth.access_token;
        REFRESH_TOKEN = auth.refresh_token;
        EXPIRES_IN = auth.expires_in;
        OBTAINED_AT = auth.obtained_at;
        setAuthArea();
        await loadAll();
      }
    }
  });

  (async function init(){
    showSetup(false);
    await maybeHandleRedirect();
    await ensureFreshToken();
    setAuthArea();
    if(ACCESS_TOKEN){ await loadAll(); }
  })();
</script>
</body>
</html>
